import streamlit as st
import pandas as pd
import subprocess
import json
import plotly.express as px  # Import Plotly Express for visualization

# Title of the App
st.title("Python Application Vulnerability Scanner")

# Instruction text
st.write("Upload your Python file to scan for vulnerabilities.")

# File uploader for Python code
uploaded_file = st.file_uploader("Choose a Python file", type=["py"])

if uploaded_file:
    # Save the uploaded file
    with open("uploaded_file.py", "wb") as f:
        f.write(uploaded_file.getbuffer())

    # Run Bandit on the uploaded file and get the report as JSON
    try:
        result = subprocess.run(
            ["bandit", "-r", "uploaded_file.py", "-f", "json"], capture_output=True, text=True
        )
        bandit_output = json.loads(result.stdout)

        # If Bandit found issues
        if bandit_output["results"]:
            # Extract relevant data for analysis
            data = {
                "Filename": [item["filename"] for item in bandit_output["results"]],
                "Issue": [item["issue_text"] for item in bandit_output["results"]],
                "Severity": [item["issue_severity"] for item in bandit_output["results"]],
                "Confidence": [item["issue_confidence"] for item in bandit_output["results"]],
                "Risk Score": [10 if item["issue_severity"] == "HIGH" else 5 for item in bandit_output["results"]],
            }
            
            df = pd.DataFrame(data)

            # Display the table of issues
            st.header("Vulnerability Report")
            st.dataframe(df)

            # Plot a bar chart of the risk scores using Plotly
            st.header("Vulnerability Risk Score Chart")
            fig = px.bar(df, x="Filename", y="Risk Score", color="Severity", 
                         title="Risk Scores by Vulnerabilities Detected",
                         labels={"Risk Score": "Risk Score", "Filename": "Filename"},
                         color_discrete_sequence=px.colors.sequential.coolwarm)

            fig.update_layout(xaxis_tickangle=-45)  # Rotate x-axis labels for better readability
            st.plotly_chart(fig)  # Use Streamlit's function to display Plotly charts

        else:
            st.write("No vulnerabilities found!")
    except Exception as e:
        st.error(f"Error running Bandit: {str(e)}")

st.write("This app scans a Python file for security vulnerabilities using Bandit.")

